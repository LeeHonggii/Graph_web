<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Processing Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h2>RAG Graph WEB</h2>
            <div class="processing-options">
                <!-- PDF 처리 모듈 선택 -->
                <div class="option-group">
                    <label for="pdfProcessingModule">PDF 처리 모듈</label>
                    <select id="pdfProcessingModule" class="dark-select">
                        <option value="">PDF 처리 모듈 선택</option>
                        <option value="pdfplumber">PDFPlumber</option>
                        <option value="pypdf">PyPDF2</option>
                        <option value="pdfminer">PDFMiner</option>
                    </select>
                </div>

                <!-- 임베딩 모듈 선택 및 청크 사이즈 설정 -->
                <div class="option-group">
                    <label for="embeddingModule">임베딩 모듈</label>
                    <select id="embeddingModule" class="dark-select">
                        <option value="">임베딩 모듈 선택</option>
                        <option value="openai">OpenAI</option>
                        <option value="sentence-transformer">SentenceTransformer</option>
                    </select>
                    
                    <div class="chunk-options">
                        <label>청크 사이즈 선택</label>
                        <div class="chunk-buttons">
                            <button type="button" class="chunk-btn" data-chunk-type="sentence">
                                문장 단위
                            </button>
                            <button type="button" class="chunk-btn" data-chunk-type="token">
                                512 토큰
                            </button>
                            <div class="custom-chunk">
                                <input type="number" 
                                       id="customChunkSize" 
                                       class="dark-input" 
                                       placeholder="사용자 정의 청크 크기"
                                       min="1"
                                       max="2048">
                                <span class="unit">토큰</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 벡터 저장 모듈 선택 -->
                <div class="option-group">
                    <label for="vectorStorageModule">벡터 저장 모듈</label>
                    <select id="vectorStorageModule" class="dark-select">
                        <option value="">벡터 저장 모듈 선택</option>
                        <option value="chroma">Chroma</option>
                        <option value="pinecone">Pinecone</option>
                    </select>
                </div>

                <!-- PDF 파일 업로드 -->
                <div class="option-group">
                    <label for="pdfFile">PDF 파일 선택</label>
                    <input type="file" id="pdfFile" class="dark-select" accept=".pdf">
                </div>

                <button id="confirmBtn" class="dark-button">분석 시작</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message user-message">
                        PDF 파일을 분석해주세요.
                    </div>
                    <div class="message assistant-message">
                        선택하신 모듈로 PDF를 분석하겠습니다. 각 페이지별 텍스트를 추출하고 문장 단위로 분석합니다...
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="메시지를 입력하세요...">
                    <button class="send-button">전송</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 기존의 청크 관련 변수
        const chunkButtons = document.querySelectorAll('.chunk-btn');
        const customChunkInput = document.getElementById('customChunkSize');
        const confirmBtn = document.getElementById('confirmBtn');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.querySelector('.send-button');
        
        // 청크 버튼 클릭 처리
        chunkButtons.forEach(button => {
            button.addEventListener('click', function() {
                chunkButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                customChunkInput.value = '';
            });
        });
        
        // 사용자 정의 입력 처리
        customChunkInput.addEventListener('input', function() {
            chunkButtons.forEach(btn => btn.classList.remove('active'));
        });
        
        // PDF 처리 함수들
        async function processPDF() {
            const pdfFile = document.getElementById('pdfFile').files[0];
            if (!pdfFile) {
                alert('PDF 파일을 선택해주세요.');
                return;
            }
            
            const config = {
                pdf_module: document.getElementById('pdfProcessingModule').value,
                chunk_type: getSelectedChunkType(),
                chunk_size: getChunkSize(),
                embedding_module: document.getElementById('embeddingModule').value,
                vector_module: document.getElementById('vectorStorageModule').value
            };
            
            const formData = new FormData();
            formData.append('file', pdfFile);
            formData.append('config', JSON.stringify(config));
            
            try {
                const response = await fetch('/process-pdf', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    addMessageToChat('assistant', `PDF 처리 완료:\n
                        - 생성된 청크 수: ${result.result.chunks_count}\n
                        - 생성된 임베딩 수: ${result.result.embeddings_count}\n
                        - 벡터 저장소 상태: ${result.result.vector_store_status}`);
                } else {
                    addMessageToChat('assistant', `오류 발생: ${result.message}`);
                }
            } catch (error) {
                addMessageToChat('assistant', `처리 중 오류가 발생했습니다: ${error.message}`);
            }
        }
        
        // 채팅 전송 함수
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            addMessageToChat('user', message);
            chatInput.value = '';
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    addMessageToChat('assistant', result.message);
                } else {
                    addMessageToChat('assistant', '죄송합니다. 오류가 발생했습니다.');
                }
            } catch (error) {
                addMessageToChat('assistant', '죄송합니다. 오류가 발생했습니다.');
                console.error('Error:', error);
            }
        }
        
        // 유틸리티 함수들
        function getSelectedChunkType() {
            const activeButton = document.querySelector('.chunk-btn.active');
            if (activeButton) {
                return activeButton.dataset.chunkType;
            }
            return 'token'; 
        }
        
        function getChunkSize() {
            const customSize = document.getElementById('customChunkSize').value;
            if (customSize) {
                return parseInt(customSize);
            }
            return 512;
        }
        
        function addMessageToChat(type, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 이벤트 리스너 설정
        confirmBtn.addEventListener('click', processPDF);
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });
    </script>
</body>
</html>